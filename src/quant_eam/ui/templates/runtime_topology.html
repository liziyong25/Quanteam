{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Whole View Runtime Topology and Service Ports Read-Only Evidence</h1>
    <p class="page-subtitle">
      Read-only governance evidence sourced from Whole View section <code>9</code>,
      Playbook sections <code>1/3</code>, and SSOT references for <code>G44</code>.
    </p>
  </div>

  <div class="card">
    <h2>Governance Boundary</h2>
    <div class="muted">This page is evidence-only and exposes no write actions.</div>
    <div class="section">
      <span class="pill">GET/HEAD only</span>
      <span class="pill">no write actions</span>
      <span class="pill">no holdout expansion</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Source Sections</h2>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>path</th><th>section</th><th>status</th></tr></thead>
          <tbody>
          {% for row in source_files %}
            <tr>
              <td><code>{{ row.path }}</code></td>
              <td>{{ row.section }}</td>
              <td>{% if row.exists %}<span class="pill good">present</span>{% else %}<span class="pill bad">missing</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>G44 Goal Snapshot</h2>
      <div class="kv">
        <div class="k">goal_id</div>
        <div class="v"><span class="pill">{{ g44.id if g44.id else "G44" }}</span></div>
        <div class="k">title</div>
        <div class="v">{{ g44.title if g44.title else "n/a" }}</div>
        <div class="k">status_now</div>
        <div class="v"><span class="pill">{{ g44.status_now if g44.status_now else "unknown" }}</span></div>
        <div class="k">ui_path</div>
        <div class="v"><code>{{ g44.ui_path if g44.ui_path else "/ui/runtime-topology" }}</code></div>
        <div class="k">depends_on</div>
        <div class="v">{{ g44.depends_on|join(", ") if g44.depends_on else "n/a" }}</div>
        <div class="k">expected_state_change</div>
        <div class="v">{{ g44.expected_state_change if g44.expected_state_change else "n/a" }}</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Runtime Topology Summary</h2>
      <div class="kv">
        <div class="k">whole_view_topology_entries</div>
        <div class="v"><span data-testid="runtime-topology-structure-total">{{ summary.topology_entry_total }}</span></div>
        <div class="k">whole_view_service_entries</div>
        <div class="v"><span data-testid="runtime-topology-service-entry-total">{{ summary.whole_view_service_entry_total }}</span></div>
        <div class="k">playbook_section1_foundation_rows</div>
        <div class="v"><span data-testid="runtime-topology-playbook-foundation-total">{{ summary.playbook_foundation_total }}</span></div>
        <div class="k">playbook_section1_service_rows</div>
        <div class="v"><span data-testid="runtime-topology-playbook-service-total">{{ summary.playbook_service_total }}</span></div>
        <div class="k">playbook_section3_runtime_phases</div>
        <div class="v"><span data-testid="runtime-topology-playbook-phase-total">{{ summary.playbook_runtime_phase_total }}</span></div>
        <div class="k">ssot_ui_ports</div>
        <div class="v"><span data-testid="runtime-topology-ui-port-total">{{ summary.ui_port_total }}</span></div>
        <div class="k">required_guards</div>
        <div class="v"><span data-testid="runtime-topology-required-guard-total">{{ summary.required_guard_total }}</span></div>
        <div class="k">expected_artifacts</div>
        <div class="v"><span data-testid="runtime-topology-expected-artifact-total">{{ summary.expected_artifact_total }}</span></div>
        <div class="k">acceptance_commands</div>
        <div class="v"><span data-testid="runtime-topology-acceptance-command-total">{{ summary.acceptance_command_total }}</span></div>
        <div class="k">runtime_required_commands</div>
        <div class="v"><span data-testid="runtime-topology-required-command-total">{{ summary.runtime_required_command_total }}</span></div>
      </div>
    </div>

    <div class="card">
      <h2>SSOT Dispatch Meta</h2>
      <div class="kv">
        <div class="k">dispatch_table</div>
        <div class="v"><code>phase_dispatch_plan_v2</code></div>
        <div class="k">dispatch.status_now</div>
        <div class="v"><span class="pill">{{ dispatch.status_now if dispatch.status_now else "n/a" }}</span></div>
        <div class="k">dispatch.mode</div>
        <div class="v"><span class="pill">{{ dispatch.mode if dispatch.mode else "n/a" }}</span></div>
        <div class="k">phase_id</div>
        <div class="v"><code>{{ dispatch.phase_id }}</code></div>
        <div class="k">goal_id</div>
        <div class="v"><code>{{ dispatch.goal_id }}</code></div>
        <div class="k">dispatch_title</div>
        <div class="v">{{ dispatch.title if dispatch.title else "n/a" }}</div>
        <div class="k">exception_id</div>
        <div class="v"><code>{{ g44_exception.exception_id if g44_exception.exception_id else "g44_runtime_topology_ui_scope" }}</code></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Whole View Section 9 Runtime Topology</h2>
    <div class="section">
      <span class="pill">{{ whole_view.section }}</span>
      <span class="pill">{{ whole_view.intro }}</span>
    </div>
    {% if whole_view.topology_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>#</th><th>entry</th><th>kind</th><th>service_evidence</th></tr></thead>
          <tbody>
          {% for row in whole_view.topology_rows %}
            <tr data-testid="runtime-topology-row-{{ loop.index }}">
              <td>{{ row.index }}</td>
              <td><code>{{ row.entry }}</code> <span class="muted">(line {{ row.source_line }})</span></td>
              <td><span class="pill">{{ row.entry_kind }}</span></td>
              <td>{% if row.is_service_evidence %}<span class="pill good">yes</span>{% else %}<span class="pill">no</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No runtime topology entries extracted from Whole View section 9.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>Playbook Section 1 Service Context</h2>
    <div class="section"><span class="pill">{{ playbook_section1.section }}</span></div>
    <div class="grid">
      <div class="section">
        <h2>{{ playbook_section1.foundation_section }}</h2>
        {% if playbook_section1.foundation_rows %}
          {% for row in playbook_section1.foundation_rows %}
            <div data-testid="runtime-topology-foundation-row-{{ loop.index }}">{{ row.item }} <span class="muted">(line {{ row.source_line }})</span></div>
          {% endfor %}
        {% else %}
          <div class="plot-fallback">No foundation rows extracted.</div>
        {% endif %}
      </div>
      <div class="section">
        <h2>{{ playbook_section1.service_section }}</h2>
        {% if playbook_section1.service_rows %}
          {% for row in playbook_section1.service_rows %}
            <div data-testid="runtime-topology-service-row-{{ loop.index }}">{{ row.item }} <span class="muted">(line {{ row.source_line }})</span></div>
          {% endfor %}
        {% else %}
          <div class="plot-fallback">No service rows extracted.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Playbook Phase Flow/Context (Section 3)</h2>
    <div class="section"><span class="pill">{{ playbook_section3 }}</span></div>
    {% if playbook_phase_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase</th><th>title</th><th>context</th><th>keywords</th></tr></thead>
          <tbody>
          {% for row in playbook_phase_rows %}
            <tr data-testid="runtime-topology-phase-row-{{ loop.index }}">
              <td><span class="pill">{{ row.phase_label }}</span></td>
              <td>{{ row.title }} <span class="muted">(line {{ row.source_line }})</span></td>
              <td>
                {% if row.goal_rows %}
                  {% for item in row.goal_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% endif %}
                {% if row.acceptance_rows %}
                  {% for item in row.acceptance_rows %}
                    <div class="muted">acceptance: {{ item }}</div>
                  {% endfor %}
                {% endif %}
              </td>
              <td>
                {% if row.matched_keywords %}
                  {{ row.matched_keywords|join(", ") }}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No runtime-focused phase rows extracted from Playbook section 3.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>SSOT Runtime Topology Governance Evidence</h2>

    <div class="section">
      <h2>g44_runtime_topology_ui_scope.required_guards</h2>
      {% if g44_exception.required_guards %}
        {% for row in g44_exception.required_guards %}
          <div data-testid="runtime-topology-required-guard-{{ loop.index }}">{{ row }}</div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No required guards found under g44_runtime_topology_ui_scope.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>ui_requirements_v1.ui_ports</h2>
      {% if ui_port_rows %}
        {% for row in ui_port_rows %}
          <div data-testid="runtime-topology-port-row-{{ loop.index }}"><code>{{ row.name }}</code>: <strong>{{ row.value }}</strong></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No UI port entries found in SSOT.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>runtime_preferences_v1.acceptance_evidence_min_set.required_commands</h2>
      {% if runtime_required_commands %}
        {% for row in runtime_required_commands %}
          <div data-testid="runtime-topology-required-command-{{ loop.index }}"><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No runtime required commands found.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>goal_checklist(G44).expected_artifacts</h2>
      {% if g44_expected_artifacts %}
        {% for row in g44_expected_artifacts %}
          <div data-testid="runtime-topology-expected-artifact-{{ loop.index }}"><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No expected artifacts listed for G44.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>goal_checklist(G44).acceptance_commands</h2>
      {% if g44_acceptance_commands %}
        {% for row in g44_acceptance_commands %}
          <div data-testid="runtime-topology-acceptance-command-{{ loop.index }}"><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No acceptance commands listed for G44.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
