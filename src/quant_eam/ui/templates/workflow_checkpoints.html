{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Whole View Workflow Checkpoints Matrix</h1>
    <p class="page-subtitle">
      Read-only evidence sourced from Whole View section <code>3</code>, Playbook phase flow text,
      and SSOT orchestration/workflow fields.
    </p>
  </div>

  <div class="card">
    <h2>Governance Boundary</h2>
    <div class="muted">This page is evidence-only and exposes no write actions.</div>
    <div class="section">
      <span class="pill">GET/HEAD only</span>
      <span class="pill">no write actions</span>
      <span class="pill">no holdout expansion</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Source Sections</h2>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>path</th><th>section</th><th>status</th></tr></thead>
          <tbody>
          {% for row in source_files %}
            <tr>
              <td><code>{{ row.path }}</code></td>
              <td>{{ row.section }}</td>
              <td>{% if row.exists %}<span class="pill good">present</span>{% else %}<span class="pill bad">missing</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>G39 Goal Snapshot</h2>
      <div class="kv">
        <div class="k">goal_id</div>
        <div class="v"><span class="pill">{{ g39.id if g39.id else "G39" }}</span></div>
        <div class="k">title</div>
        <div class="v">{{ g39.title if g39.title else "n/a" }}</div>
        <div class="k">status_now</div>
        <div class="v"><span class="pill">{{ g39.status_now if g39.status_now else "unknown" }}</span></div>
        <div class="k">ui_path</div>
        <div class="v"><code>{{ g39.ui_path if g39.ui_path else "n/a" }}</code></div>
        <div class="k">depends_on</div>
        <div class="v">{{ g39.depends_on|join(", ") if g39.depends_on else "n/a" }}</div>
        <div class="k">expected_state_change</div>
        <div class="v">{{ g39.expected_state_change if g39.expected_state_change else "n/a" }}</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Matrix Summary</h2>
      <div class="kv">
        <div class="k">whole_view_phases</div>
        <div class="v"><span data-testid="workflow-whole-view-phase-total">{{ summary.whole_view_phase_total }}</span></div>
        <div class="k">whole_view_ui_checkpoints</div>
        <div class="v"><span data-testid="workflow-whole-view-checkpoint-total">{{ summary.whole_view_checkpoint_total }}</span></div>
        <div class="k">playbook_phases</div>
        <div class="v"><span data-testid="workflow-playbook-phase-total">{{ summary.playbook_phase_total }}</span></div>
        <div class="k">mapped_whole_view_phases</div>
        <div class="v"><span data-testid="workflow-mapped-phase-total">{{ summary.mapped_phase_total }}</span></div>
        <div class="k">ssot_pipeline_steps</div>
        <div class="v"><span data-testid="workflow-pipeline-step-total">{{ summary.ssot_pipeline_step_total }}</span></div>
        <div class="k">ssot_pipeline_checkpoint_steps</div>
        <div class="v"><span data-testid="workflow-pipeline-checkpoint-total">{{ summary.ssot_pipeline_checkpoint_total }}</span></div>
        <div class="k">orchestrator_cycle_items</div>
        <div class="v"><span data-testid="workflow-autopilot-cycle-total">{{ summary.autopilot_cycle_total }}</span></div>
      </div>
    </div>

    <div class="card">
      <h2>SSOT Workflow Meta</h2>
      <div class="kv">
        <div class="k">table</div>
        <div class="v"><code>phase_dispatch_plan_v2</code></div>
        <div class="k">dispatch.status_now</div>
        <div class="v"><span class="pill">{{ dispatch.status_now if dispatch.status_now else "n/a" }}</span></div>
        <div class="k">dispatch.mode</div>
        <div class="v"><span class="pill">{{ dispatch.mode if dispatch.mode else "n/a" }}</span></div>
        <div class="k">phase_id</div>
        <div class="v"><code>{{ dispatch.phase_id }}</code></div>
        <div class="k">goal_id</div>
        <div class="v"><code>{{ dispatch.goal_id }}</code></div>
        <div class="k">dispatch_title</div>
        <div class="v"><code>{{ dispatch.title if dispatch.title else "n/a" }}</code></div>
        <div class="k">pipeline</div>
        <div class="v"><code>agents_pipeline_v1</code></div>
        <div class="k">execution_model</div>
        <div class="v"><span class="pill">{{ pipeline.execution_model if pipeline.execution_model else "n/a" }}</span></div>
        <div class="k">orchestration_owner</div>
        <div class="v"><span class="pill">{{ pipeline.orchestration_owner if pipeline.orchestration_owner else "n/a" }}</span></div>
        <div class="k">autopilot</div>
        <div class="v"><code>orchestrator_autopilot_v1</code></div>
        <div class="k">autopilot_enabled</div>
        <div class="v"><span class="pill">{{ "true" if autopilot.enabled else "false" }}</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Whole View Section 3 Workflow Matrix</h2>
    {% if whole_view_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase</th><th>workflow_evidence</th><th>ui_checkpoint</th><th>inferred_ssot_checkpoint_step</th><th>ssot_mapping</th></tr></thead>
          <tbody>
          {% for row in whole_view_rows %}
            <tr data-testid="workflow-whole-view-row-{{ loop.index }}">
              <td>
                <div><span class="pill">{{ row.phase_label }}</span></div>
                <div>{{ row.title }}</div>
                <div class="muted">line {{ row.source_line }}</div>
              </td>
              <td>
                {% if row.evidence_rows %}
                  {% for item in row.evidence_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
              <td>
                {% if row.checkpoint_no is not none %}
                  <div><span class="pill">{{ row.checkpoint_label }}</span></div>
                  <div>{{ row.checkpoint_detail }}</div>
                {% else %}
                  <span class="muted">no explicit UI checkpoint text</span>
                {% endif %}
              </td>
              <td>{% if row.inferred_checkpoint_step %}<span class="pill">{{ row.inferred_checkpoint_step }}</span>{% else %}<span class="muted">n/a</span>{% endif %}</td>
              <td>
                {% if row.mapping_status == "mapped" %}
                  <span class="pill good">mapped</span>
                {% elif row.mapping_status == "inferred_only" %}
                  <span class="pill">inferred_only</span>
                {% else %}
                  <span class="pill bad">n/a</span>
                {% endif %}
                {% if row.mapped_agents %}
                  {% for agent_id in row.mapped_agents %}
                    <div><code>{{ agent_id }}</code></div>
                  {% endfor %}
                {% endif %}
                {% if row.mapped_goal_ids %}
                  <div class="muted">goal_ids: {{ row.mapped_goal_ids|join(", ") }}</div>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No workflow phases extracted from Whole View section 3.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>Playbook Phase Flow (Section 3)</h2>
    {% if playbook_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase</th><th>title</th><th>goal_highlights</th><th>acceptance_highlights</th></tr></thead>
          <tbody>
          {% for row in playbook_rows %}
            <tr data-testid="workflow-playbook-row-{{ loop.index }}">
              <td><span class="pill">{{ row.phase_label }}</span></td>
              <td>
                <div>{{ row.title }}</div>
                <div class="muted">line {{ row.source_line }}</div>
              </td>
              <td>
                {% if row.goal_rows %}
                  {% for item in row.goal_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
              <td>
                {% if row.acceptance_rows %}
                  {% for item in row.acceptance_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No phase-flow rows extracted from Playbook section 3.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>SSOT Orchestration/Workflow Evidence</h2>
    <div class="section">
      <h2>orchestrator_autopilot_v1.cycle</h2>
      {% if autopilot.cycle_rows %}
        {% for row in autopilot.cycle_rows %}
          <div data-testid="workflow-autopilot-cycle-{{ loop.index }}"><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No cycle rows under orchestrator_autopilot_v1.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>agents_pipeline_v1 Checkpoint Steps</h2>
      {% if pipeline.checkpoint_summary_rows %}
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>checkpoint_step</th><th>agent_ids</th><th>mapped_goal_ids</th><th>step_total</th></tr></thead>
            <tbody>
            {% for row in pipeline.checkpoint_summary_rows %}
              <tr data-testid="workflow-ssot-checkpoint-row-{{ loop.index }}">
                <td><span class="pill">{{ row.checkpoint_step }}</span></td>
                <td>{{ row.agent_ids|join(", ") if row.agent_ids else "n/a" }}</td>
                <td>{{ row.mapped_goal_ids|join(", ") if row.mapped_goal_ids else "n/a" }}</td>
                <td>{{ row.step_total }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="plot-fallback">No checkpoint rows under agents_pipeline_v1.</div>
      {% endif %}
    </div>

    {% if autopilot.priority_order %}
    <div class="section">
      <h2>orchestrator_autopilot_v1.next_goal_policy.priority_order</h2>
      <div class="muted">Top 12 entries:</div>
      {% for row in autopilot.priority_order[:12] %}
        <div><span class="pill">{{ row }}</span></div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
{% endblock %}
