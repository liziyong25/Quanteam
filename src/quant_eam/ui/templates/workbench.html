{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Workbench</h1>
    <p class="page-subtitle">Phase-0 to Phase-4 session orchestration entry. Session state, cards, and events are persisted under artifacts/workbench.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Active Sessions</h2>
      {% if sessions and sessions|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>session_id</th>
              <th>status</th>
              <th>current step</th>
              <th>title</th>
              <th>updated_at</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sessions %}
            <tr>
              <td><a href="/ui/workbench/{{ s.session_id }}">{{ s.session_id }}</a></td>
              <td><span class="pill">{{ s.status }}</span></td>
              <td>{{ s.current_step }}</td>
              <td>{{ s.title }}</td>
              <td>{{ s.updated_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No workbench sessions yet. Create one via POST /workbench/sessions.</div>
      {% endif %}
      <p class="muted">
        Requirement entry alias:
        {% for alias in requirement_entry_aliases %}
          {% if not loop.first %} | {% endif %}
          <a href="{{ alias }}">{{ alias }}</a>
        {% endfor %}
      </p>
    </div>

    <div class="card">
      <h2>Create Session (UI)</h2>
      <form method="post" action="/workbench/sessions" class="form-grid" data-loading-form="1">
        <input type="hidden" name="_ui" value="1"/>
        <label>
          <span>title</span>
          <input name="title" value="Workbench idea" required/>
        </label>
        <label>
          <span>symbols</span>
          <input name="symbols" value="AAPL,MSFT" required/>
        </label>
        <label class="full">
          <span>hypothesis_text</span>
          <textarea name="hypothesis_text" rows="3" required>Mean revert entry</textarea>
        </label>
        <label class="full">
          <span>message (real-jobs mode)</span>
          <textarea name="message" rows="2" placeholder="帮我检查A股 MA250 的有效性"></textarea>
        </label>
        <label>
          <span>frequency</span>
          <input name="frequency" value="1d"/>
        </label>
        <label>
          <span>evaluation_intent</span>
          <input name="evaluation_intent" value="demo_e2e"/>
        </label>
        <div class="full">
          <button type="submit" class="btn" data-loading-label="Creating...">Create Workbench Session</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <h2>Workbench API Quick Start</h2>
    <pre class="code">
{% for item in route_inventory %}
{{ item.method }} {{ item.path }}
{% endfor %}
    </pre>
      <p class="muted">Artifacts:
        <code>artifacts/workbench/sessions/&lt;session_id&gt;/session.json</code>,
        <code>artifacts/workbench/sessions/&lt;session_id&gt;/events.jsonl</code>,
        <code>artifacts/jobs/&lt;job_id&gt;/outputs/workbench/cards/*.json</code>,
        <code>artifacts/jobs/&lt;job_id&gt;/outputs/workbench/step_drafts/&lt;step&gt;/selected.json</code>
      </p>
  </div>

  <div class="card">
    <h2>WB-045 Phase Result Card Matrix</h2>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr><th>phase</th><th>step</th><th>title</th><th>result cards</th><th>actions</th><th>evidence anchors</th></tr>
        </thead>
        <tbody>
          {% for row in phase_result_matrix %}
          <tr>
            <td><span class="pill">{{ row.phase_label }}</span></td>
            <td><code>{{ row.step }}</code></td>
            <td>{{ row.title }}</td>
            <td>{{ row.result_cards | join(" | ") }}</td>
            <td>{{ row.actions | join(" | ") }}</td>
            <td>{{ row.evidence_focus | join(" | ") }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if selected_session %}
      {% set s = selected_session.session %}
    <div class="card" id="workbench-session-detail" data-session-id="{{ s.session_id }}" data-event-count="{{ selected_session.event_count }}">
      <h2>Session Detail</h2>
      <div class="code-wrap">
        <p><strong>Session:</strong> {{ s.session_id }} | <strong>status:</strong> {{ s.status }} | <strong>current step:</strong> {{ s.current_step }}</p>
        <p><strong>job_id:</strong> {{ s.job_id }} | <strong>created:</strong> {{ s.created_at }}</p>
        <p><strong>cards:</strong> {{ selected_session.cards_path }}</p>
      </div>
      {% set failure = s.last_failure if s.last_failure else {} %}
      {% if failure and failure.get("readable_message") %}
      <h3>Failure Explainability (WB-026)</h3>
      <div class="plot-fallback">{{ failure.get("readable_message") }}</div>
      <div class="table-wrap">
        <table class="table">
          <tbody>
            <tr><th>failure_reason</th><td>{{ failure.get("failure_reason", "") }}</td></tr>
            <tr><th>step</th><td>{{ failure.get("step", "") }}</td></tr>
            <tr><th>source</th><td>{{ failure.get("source", "") }}</td></tr>
            <tr><th>event_id</th><td>{{ failure.get("event_id", "") }}</td></tr>
          </tbody>
        </table>
      </div>
      {% if failure.get("evidence_refs") and failure.get("evidence_refs")|length > 0 %}
      <p><strong>Evidence refs</strong></p>
      <ul>
        {% for ref in failure.get("evidence_refs", []) %}
        <li><code>{{ ref }}</code></li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endif %}

      <h3>Actions</h3>
      <div class="grid">
        <div>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/continue" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <input type="hidden" name="idempotency_key" value="" data-idempotency-input="continue" data-session-id="{{ s.session_id }}"/>
            <label>
              <span>target_step (optional)</span>
              <select name="target_step">
                <option value="">auto next</option>
                {% for step in selected_session.steps %}
                <option value="{{ step }}">{{ step }}</option>
                {% endfor %}
              </select>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Continuing...">Continue / Refresh</button>
            </div>
          </form>
        </div>
        <div>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/fetch-probe" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <input type="hidden" name="idempotency_key" value="" data-idempotency-input="fetch_probe" data-session-id="{{ s.session_id }}"/>
            <label>
              <span>symbols</span>
              <input name="symbols" value="{{ (s.idea.symbols | join(',')) if s.idea and s.idea.symbols else '' }}" placeholder="AAPL,MSFT"/>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Fetching...">Run Fetch Probe</button>
            </div>
          </form>
        </div>
      </div>

      <h3>Recovery Loop (FR-009)</h3>
      {% set recovery = selected_session.current_step_recovery if selected_session.current_step_recovery else {} %}
      <p class="muted">
        active_step={{ s.current_step }} |
        selected_draft={{ recovery.get("selected_version") if recovery.get("selected_version") else "none" }} |
        previous_draft={{ recovery.get("previous_version") if recovery.get("previous_version") else "none" }}
      </p>
      <div class="grid">
        <div>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/steps/{{ s.current_step }}/rerun" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <input type="hidden" name="idempotency_key" value="" data-idempotency-input="step_rerun" data-session-id="{{ s.session_id }}"/>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Rerunning...">Rerun Current Step</button>
            </div>
          </form>
        </div>
        <div>
          {% if s.current_step != "idea" %}
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/steps/{{ s.current_step }}/drafts" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <label class="full">
              <span>edit draft JSON</span>
              <textarea name="content_json" rows="5" placeholder='{"note":"refine strategy logic"}' required></textarea>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Saving...">Save Draft Version</button>
            </div>
          </form>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/steps/{{ s.current_step }}/drafts/apply" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <input type="hidden" name="idempotency_key" value="" data-idempotency-input="draft_apply" data-session-id="{{ s.session_id }}"/>
            <label>
              <span>historical draft version</span>
              <input name="version" type="number" min="1" step="1" placeholder="e.g. 1" required/>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Applying...">Apply Draft Version</button>
            </div>
          </form>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/steps/{{ s.current_step }}/drafts/rollback" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <input type="hidden" name="idempotency_key" value="" data-idempotency-input="draft_rollback" data-session-id="{{ s.session_id }}"/>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Rolling back...">Rollback To Previous Draft</button>
            </div>
          </form>
          {% if recovery.get("selection_history") and recovery.get("selection_history")|length > 0 %}
          <p class="muted">selection_history: {{ recovery.get("selection_history") | join(" -> ") }}</p>
          {% endif %}
          {% if recovery.get("selection_snapshot") %}
          {% set snap = recovery.get("selection_snapshot") %}
          {% set selected_snap = snap.get("selected") if snap.get("selected") else {} %}
          {% set prev_snap = snap.get("previous_selected") if snap.get("previous_selected") else {} %}
          <p class="muted">
            snapshot selected={{ selected_snap.get("version") if selected_snap.get("version") else "none" }}
            (hash={{ selected_snap.get("content_hash") if selected_snap.get("content_hash") else "none" }})
            | previous={{ prev_snap.get("version") if prev_snap.get("version") else "none" }}
          </p>
          {% endif %}
          {% else %}
          <div class="plot-fallback">Draft apply/rollback is available after entering a non-idea step.</div>
          {% endif %}
        </div>
      </div>

      <h3>Phase-0 Fetch Preview</h3>
      {% set fetch_status = s.fetch_probe_status if s.fetch_probe_status else 'idle' %}
      <p><strong>Status:</strong> <span class="pill">{{ fetch_status }}</span></p>
      {% if s.fetch_probe_error %}
        <div class="plot-fallback">Last fetch error: {{ s.fetch_probe_error }}</div>
        {% if s.fetch_probe_error_ref %}
        <p class="muted">fetch error evidence: <code>{{ s.fetch_probe_error_ref }}</code></p>
        {% endif %}
      {% elif fetch_status == "running" %}
        <div class="plot-fallback">Fetch probe is running. Refresh this page to see the latest preview state.</div>
      {% endif %}
      {% if s.fetch_probe_preview_rows and s.fetch_probe_preview_rows|length > 0 %}
      {% set preview_rows = s.fetch_probe_preview_rows %}
      {% set preview_cols = preview_rows[0].keys() %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              {% for c in preview_cols %}
              <th>{{ c }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in preview_rows %}
            <tr>
              {% for c in preview_cols %}
              <td>{{ row.get(c, '') }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No fetch preview rows yet.</div>
      {% endif %}

      <h3>Trace</h3>
      {% if s.trace and s.trace|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>step</th><th>status</th><th>status_text</th><th>action</th></tr>
          </thead>
          <tbody>
            {% for row in s.trace %}
            <tr>
              <td>{{ row.step }}</td>
              <td>{{ row.status }}</td>
              <td>{{ row.status_text }}</td>
              <td>
                {% if row.step == s.current_step %}
                  <form method="post" action="/workbench/sessions/{{ s.session_id }}/continue" data-loading-form="1">
                    <input type="hidden" name="_ui" value="1"/>
                    <input type="hidden" name="idempotency_key" value="" data-idempotency-input="continue" data-session-id="{{ s.session_id }}"/>
                    <input type="hidden" name="target_step" value="{{ row.step }}"/>
                    <button type="submit" class="btn btn-small" data-loading-label="继续中...">继续</button>
                  </form>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No trace rows yet.</div>
      {% endif %}

      <h3>Recent Events ({{ selected_session.event_count }})</h3>
      {% if selected_session.events and selected_session.events|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>time</th><th>step</th><th>event</th></tr>
          </thead>
          <tbody>
            {% for item in selected_session.events %}
            <tr>
              <td>{{ item.created_at }}</td>
              <td>{{ item.step }}</td>
              <td>{{ item.event_type }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No events yet.</div>
      {% endif %}

      <h3>Result Cards ({{ selected_session.cards_count }})</h3>
      {% if selected_session.phase_cards and selected_session.phase_cards|length > 0 %}
      <div class="card-stack">
        {% for phase_row in selected_session.phase_cards %}
        {% set card = phase_row.card if phase_row.card else {} %}
        <div class="card" data-testid="workbench-phase-card-{{ phase_row.step }}">
          <p><strong>{{ phase_row.phase_label }}</strong> | {{ phase_row.title }} | <code>{{ card.card_id if phase_row.available else "pending" }}</code></p>
          <p class="muted">Expected result cards: {{ phase_row.result_cards | join(" | ") }}</p>
          <p class="muted">Expected actions: {{ phase_row.actions | join(" | ") }}</p>
          {% if phase_row.available %}
          {% if card.summary_lines and card.summary_lines|length > 0 %}
          <ul>
            {% for line in card.summary_lines %}
            <li>{{ line }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="plot-fallback">No summary lines.</div>
          {% endif %}
          {% if card.phase == "strategy_spec" and card.details %}
            {% set readable = card.details.get("strategy_readable", {}) %}
            {% set wb052 = readable.get("wb052_cards", {}) if readable else {} %}
            {% set pseudo_card = wb052.get("strategy_pseudocode", {}) %}
            {% set var_card = wb052.get("variable_dictionary_summary", {}) %}
            {% set trace_card = wb052.get("calc_trace_plan_summary", {}) %}
            {% set risk_card = wb052.get("spec_qa_risk", {}) %}
            <p><strong>strategy_pseudocode card</strong></p>
            <p class="muted">status={{ pseudo_card.get("status", "missing") }} | source=<code>{{ pseudo_card.get("source_path", "") }}</code></p>
            {% if pseudo_card.get("status") == "ready" and pseudo_card.get("pseudocode_text") %}
              <pre class="code" data-testid="wb052-card-strategy-pseudocode">{{ pseudo_card.get("pseudocode_text", "") }}</pre>
            {% elif pseudo_card.get("status") == "error" %}
              <div class="plot-fallback" data-testid="wb052-card-strategy-pseudocode">strategy_pseudocode unavailable: {{ pseudo_card.get("reason", "invalid_source") }}</div>
            {% else %}
              <div class="plot-fallback" data-testid="wb052-card-strategy-pseudocode">strategy_pseudocode pending: missing source evidence.</div>
            {% endif %}

            <p><strong>variable_dictionary summary card</strong></p>
            <p class="muted">status={{ var_card.get("status", "missing") }} | source=<code>{{ var_card.get("source_path", "") }}</code></p>
            {% if var_card.get("status") == "ready" %}
              <div class="table-wrap" data-testid="wb052-card-variable-dictionary">
                <table class="table">
                  <tbody>
                    <tr><th>variable_count</th><td>{{ var_card.get("variable_count", 0) }}</td></tr>
                    <tr><th>lagged_variable_count</th><td>{{ var_card.get("lagged_variable_count", 0) }}</td></tr>
                    <tr><th>sample_var_ids</th><td>{{ var_card.get("sample_var_ids", []) | join(", ") }}</td></tr>
                    <tr><th>kind_counts</th><td>{{ var_card.get("kind_counts", {}) | tojson }}</td></tr>
                  </tbody>
                </table>
              </div>
            {% elif var_card.get("status") == "error" %}
              <div class="plot-fallback" data-testid="wb052-card-variable-dictionary">variable_dictionary summary unavailable: {{ var_card.get("reason", "invalid_source") }}</div>
            {% else %}
              <div class="plot-fallback" data-testid="wb052-card-variable-dictionary">variable_dictionary summary pending: missing source evidence.</div>
            {% endif %}

            <p><strong>calc_trace_plan summary card</strong></p>
            <p class="muted">status={{ trace_card.get("status", "missing") }} | source=<code>{{ trace_card.get("source_path", "") }}</code></p>
            {% if trace_card.get("status") == "ready" %}
              <div class="table-wrap" data-testid="wb052-card-calc-trace-plan">
                <table class="table">
                  <tbody>
                    <tr><th>step_count</th><td>{{ trace_card.get("step_count", 0) }}</td></tr>
                    <tr><th>assertion_count</th><td>{{ trace_card.get("assertion_count", 0) }}</td></tr>
                    <tr><th>sample_count</th><td>{{ trace_card.get("sample_count", 0) }}</td></tr>
                    <tr><th>first_step_title</th><td>{{ trace_card.get("first_step_title", "") }}</td></tr>
                    <tr><th>first_step_variables</th><td>{{ trace_card.get("first_step_variables", []) | join(", ") }}</td></tr>
                    <tr><th>sample_windows</th><td>{{ trace_card.get("sample_windows", []) | join(" ; ") }}</td></tr>
                  </tbody>
                </table>
              </div>
            {% elif trace_card.get("status") == "error" %}
              <div class="plot-fallback" data-testid="wb052-card-calc-trace-plan">calc_trace_plan summary unavailable: {{ trace_card.get("reason", "invalid_source") }}</div>
            {% else %}
              <div class="plot-fallback" data-testid="wb052-card-calc-trace-plan">calc_trace_plan summary pending: missing source evidence.</div>
            {% endif %}

            <p><strong>Spec-QA risk card</strong></p>
            <p class="muted">status={{ risk_card.get("status", "missing") }} | source=<code>{{ risk_card.get("source_path", "") }}</code></p>
            {% if risk_card.get("status") == "ready" %}
              <div class="table-wrap" data-testid="wb052-card-spec-qa-risk">
                <table class="table">
                  <tbody>
                    <tr><th>overall</th><td>{{ risk_card.get("overall", "pending") }}</td></tr>
                    <tr><th>finding_count</th><td>{{ risk_card.get("finding_count", 0) }}</td></tr>
                    <tr><th>error_count</th><td>{{ risk_card.get("error_count", 0) }}</td></tr>
                    <tr><th>warn_count</th><td>{{ risk_card.get("warn_count", 0) }}</td></tr>
                  </tbody>
                </table>
              </div>
              {% if risk_card.get("highlights") and risk_card.get("highlights")|length > 0 %}
                <ul>
                  {% for row in risk_card.get("highlights", []) %}
                  <li>{{ row }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="plot-fallback">Spec-QA risk highlights are empty.</div>
              {% endif %}
            {% elif risk_card.get("status") == "error" %}
              <div class="plot-fallback" data-testid="wb052-card-spec-qa-risk">Spec-QA risk unavailable: {{ risk_card.get("reason", "invalid_source") }}</div>
            {% else %}
              <div class="plot-fallback" data-testid="wb052-card-spec-qa-risk">Spec-QA risk pending: missing source evidence.</div>
            {% endif %}
          {% endif %}
          {% if card.phase == "trace_preview" and card.details %}
            {% set overlay = card.details.get("kline_overlay", {}) %}
            <p><strong>K-line overlay</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>bars</th><td>{{ overlay.get("bars", 0) }}</td></tr>
                  <tr><th>symbols</th><td>{{ overlay.get("symbols", []) | join(", ") }}</td></tr>
                  <tr><th>window</th><td>{{ overlay.get("dt_start", "?") }} -> {{ overlay.get("dt_end", "?") }}</td></tr>
                  <tr><th>entry_lagged_true</th><td>{{ overlay.get("entry_lagged_true_count", 0) }}</td></tr>
                  <tr><th>exit_lagged_true</th><td>{{ overlay.get("exit_lagged_true_count", 0) }}</td></tr>
                </tbody>
              </table>
            </div>
            {% set card_rows = card.details.get("sample_rows", []) %}
            <p><strong>K-line overlay sample rows</strong></p>
            {% if card_rows and card_rows|length > 0 %}
              {% set card_cols = card_rows[0].keys() %}
              <div class="table-wrap">
                <table class="table">
                  <thead>
                    <tr>
                      {% for c in card_cols %}
                      <th>{{ c }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in card_rows %}
                    <tr>
                      {% for c in card_cols %}
                      <td>{{ row.get(c, "") }}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="plot-fallback">No K-line overlay sample rows yet.</div>
            {% endif %}
            {% set assertions = card.details.get("trace_assertions", {}) %}
            <p><strong>Trace assertions</strong></p>
            {% if assertions.get("samples") and assertions.get("samples")|length > 0 %}
            <ul>
              {% for row in assertions.get("samples", []) %}
              <li>{{ row }}</li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="plot-fallback">No trace assertion samples.</div>
            {% endif %}
            {% set sanity = card.details.get("sanity_metrics", {}) %}
            {% set fetch_sanity = sanity.get("fetch_sanity", {}) %}
            {% set trace_meta = sanity.get("trace_meta", {}) %}
            <p><strong>Sanity metrics</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>trace_rows_written</th><td>{{ trace_meta.get("rows_written", 0) }}</td></tr>
                  <tr><th>lag_bars_used</th><td>{{ trace_meta.get("lag_bars_used", 0) }}</td></tr>
                  <tr><th>fetch_preview_row_count</th><td>{{ fetch_sanity.get("preview_row_count", 0) }}</td></tr>
                  <tr><th>timestamp_duplicate_count</th><td>{{ fetch_sanity.get("timestamp_duplicate_count", 0) }}</td></tr>
                  <tr><th>timestamp_monotonic_non_decreasing</th><td>{{ fetch_sanity.get("timestamp_monotonic_non_decreasing", false) }}</td></tr>
                  <tr><th>dtype_reasonable</th><td>{{ fetch_sanity.get("dtype_reasonable", true) }}</td></tr>
                  <tr><th>nonzero_missing_ratio_columns</th><td>{{ fetch_sanity.get("nonzero_missing_ratio_columns", []) | join(", ") }}</td></tr>
                </tbody>
              </table>
            </div>
          {% endif %}
          {% if card.phase == "runspec" and card.details %}
            {% set signal = card.details.get("signal_summary", {}) %}
            {% set perf = card.details.get("performance_summary", {}) %}
            {% set gate = card.details.get("gate_summary", {}) %}
            {% set trade_rows = card.details.get("trade_samples", []) %}
            <p><strong>Signal summary</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>pseudocode_lines</th><td>{{ signal.get("pseudocode_lines", []) | length }}</td></tr>
                  <tr><th>variable_count</th><td>{{ signal.get("variable_count", 0) }}</td></tr>
                  <tr><th>assertion_count</th><td>{{ signal.get("assertion_count", 0) }}</td></tr>
                </tbody>
              </table>
            </div>
            {% if signal.get("pseudocode_lines") and signal.get("pseudocode_lines")|length > 0 %}
              <pre class="code">{{ signal.get("pseudocode_lines", []) | join("\n") }}</pre>
            {% endif %}
            <p><strong>Return/Drawdown/Gate summary</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>run_id</th><td>{{ perf.get("run_id", "") }}</td></tr>
                  <tr><th>total_return</th><td>{{ perf.get("total_return", "") }}</td></tr>
                  <tr><th>max_drawdown</th><td>{{ perf.get("max_drawdown", "") }}</td></tr>
                  <tr><th>sharpe</th><td>{{ perf.get("sharpe", "") }}</td></tr>
                  <tr><th>trade_count</th><td>{{ perf.get("trade_count", "") }}</td></tr>
                  <tr><th>overall_pass</th><td>{{ gate.get("overall_pass", false) }}</td></tr>
                  <tr><th>failed_gates</th><td>{{ gate.get("failed_gate_ids", []) | join(", ") }}</td></tr>
                </tbody>
              </table>
            </div>
            <p><strong>Trade samples</strong></p>
            {% if trade_rows and trade_rows|length > 0 %}
              {% set trade_cols = trade_rows[0].keys() %}
              <div class="table-wrap">
                <table class="table">
                  <thead>
                    <tr>
                      {% for c in trade_cols %}
                      <th>{{ c }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in trade_rows %}
                    <tr>
                      {% for c in trade_cols %}
                      <td>{{ row.get(c, "") }}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="plot-fallback">No trade sample rows yet.</div>
            {% endif %}
          {% endif %}
          {% if card.phase == "improvements" and card.details %}
            {% set attr = card.details.get("attribution_summary", {}) %}
            {% set candidates = card.details.get("improvement_candidates", []) %}
            {% set registry_state = card.details.get("registry_state", {}) %}
            {% set composer = card.details.get("composer_result", {}) %}
            <p><strong>Attribution summary</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>available</th><td>{{ attr.get("available", false) }}</td></tr>
                  <tr><th>net_return</th><td>{{ attr.get("net_return", "") }}</td></tr>
                  <tr><th>gross_return</th><td>{{ attr.get("gross_return", "") }}</td></tr>
                  <tr><th>max_drawdown</th><td>{{ attr.get("max_drawdown", "") }}</td></tr>
                  <tr><th>trade_count</th><td>{{ attr.get("trade_count", "") }}</td></tr>
                  <tr><th>overall_pass</th><td>{{ attr.get("overall_pass", "") }}</td></tr>
                </tbody>
              </table>
            </div>
            <p><strong>Improvement candidates</strong></p>
            {% if candidates and candidates|length > 0 %}
            <div class="table-wrap">
              <table class="table">
                <thead><tr><th>proposal_id</th><th>title</th><th>rationale_refs</th></tr></thead>
                <tbody>
                  {% for row in candidates %}
                  <tr>
                    <td>{{ row.get("proposal_id", "") }}</td>
                    <td>{{ row.get("title", "") }}</td>
                    <td>{{ row.get("rationale_ref_count", 0) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="plot-fallback">No improvement candidates.</div>
            {% endif %}
            <p><strong>Registry/card state + composer result</strong></p>
            <div class="table-wrap">
              <table class="table">
                <tbody>
                  <tr><th>card_id</th><td>{{ registry_state.get("card_id", "") }}</td></tr>
                  <tr><th>card_available</th><td>{{ registry_state.get("available", false) }}</td></tr>
                  <tr><th>card_status</th><td>{{ registry_state.get("effective_status", "") }}</td></tr>
                  <tr><th>eligible_for_compose</th><td>{{ composer.get("eligible_for_compose", false) }}</td></tr>
                  <tr><th>compose_candidate_count</th><td>{{ composer.get("candidate_count", 0) }}</td></tr>
                </tbody>
              </table>
            </div>
          {% endif %}
          {% if card.details and card.details.get("wb052_dependency_field_map") %}
            <details>
              <summary>WB-052 dependency field map</summary>
              <div class="table-wrap">
                <table class="table">
                  <thead><tr><th>field</th><th>required_by</th><th>status</th><th>reason</th><th>path</th></tr></thead>
                  <tbody>
                    {% for row in card.details.get("wb052_dependency_field_map", []) %}
                    <tr>
                      <td>{{ row.get("field", "") }}</td>
                      <td>{{ row.get("required_by", "") }}</td>
                      <td>{{ row.get("status", "missing") }}</td>
                      <td>{{ row.get("reason", "") }}</td>
                      <td><code>{{ row.get("path", "") }}</code></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </details>
          {% endif %}
          {% if card.details and card.details.get("g356_dependency_field_map") %}
            <details>
              <summary>G356 dependency field map</summary>
              <div class="table-wrap">
                <table class="table">
                  <thead><tr><th>field</th><th>required_by</th><th>present</th><th>path</th></tr></thead>
                  <tbody>
                    {% for row in card.details.get("g356_dependency_field_map", []) %}
                    <tr>
                      <td>{{ row.get("field", "") }}</td>
                      <td>{{ row.get("required_by", "") }}</td>
                      <td>{{ row.get("present", false) }}</td>
                      <td><code>{{ row.get("path", "") }}</code></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </details>
          {% endif %}
          {% if card.evidence_artifact_rows and card.evidence_artifact_rows|length > 0 %}
            <p><strong>Expanded evidence</strong></p>
            {% for ev in card.evidence_artifact_rows %}
              <details>
                <summary>Raw artifact path: <code>{{ ev.raw_path }}</code></summary>
                <p class="muted">resolved: <code>{{ ev.resolved_path }}</code> | kind: {{ ev.kind }} | size: {{ ev.size_bytes }} bytes</p>
                {% if not ev.safe %}
                  <div class="plot-fallback">Blocked by safe path guard: {{ ev.blocked_reason }}</div>
                {% elif not ev.exists %}
                  <div class="plot-fallback">Artifact file does not exist.</div>
                {% elif ev.kind == "json" %}
                  <p><strong>JSON detail view</strong></p>
                  {% if ev.preview_error %}
                    <div class="plot-fallback">{{ ev.preview_error }}</div>
                  {% else %}
                    <pre class="code">{{ ev.preview_json }}</pre>
                  {% endif %}
                {% elif ev.kind == "csv" %}
                  <p><strong>CSV detail view</strong></p>
                  {% if ev.preview_rows and ev.preview_rows|length > 0 %}
                    <div class="table-wrap">
                      <table class="table">
                        <thead>
                          <tr>
                            {% for c in ev.preview_columns %}
                            <th>{{ c }}</th>
                            {% endfor %}
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in ev.preview_rows %}
                          <tr>
                            {% for c in ev.preview_columns %}
                            <td>{{ row.get(c, "") }}</td>
                            {% endfor %}
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="plot-fallback">CSV file has no preview rows.</div>
                  {% endif %}
                {% else %}
                  <p><strong>Text detail view</strong></p>
                  {% if ev.preview_error %}
                    <div class="plot-fallback">{{ ev.preview_error }}</div>
                  {% else %}
                    <pre class="code">{{ ev.preview_text }}</pre>
                  {% endif %}
                {% endif %}
              </details>
            {% endfor %}
          {% endif %}
          <details>
            <summary>Evidence details (collapsed by default)</summary>
            <pre class="code">{{ card.evidence_json }}</pre>
          </details>
          <details>
            <summary>Card payload</summary>
            <pre class="code">{{ card.details_json }}</pre>
          </details>
          <p class="muted"><code>{{ card.artifact_path }}</code></p>
          {% else %}
          <div class="plot-fallback">No result card yet for this phase. Continue the session to generate it.</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="plot-fallback">No result cards yet. Continue the session to generate phase cards.</div>
      {% endif %}
    </div>
  {% endif %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var refreshPending = false;

      function randomSuffix() {
        if (window.crypto && window.crypto.randomUUID) {
          return window.crypto.randomUUID().replace(/-/g, "");
        }
        return String(Date.now()) + String(Math.random()).replace(/\D/g, "");
      }

      document.querySelectorAll("input[data-idempotency-input]").forEach(function (input, idx) {
        if (input.value) {
          return;
        }
        var action = String(input.getAttribute("data-idempotency-input") || "action").trim() || "action";
        var sessionId = String(input.getAttribute("data-session-id") || "").trim();
        var suffix = randomSuffix().slice(0, 28);
        var key = sessionId ? [action, sessionId, String(idx + 1), suffix].join("-") : [action, String(idx + 1), suffix].join("-");
        input.value = key.slice(0, 64);
      });

      document.querySelectorAll("form[data-loading-form='1']").forEach(function (form) {
        form.addEventListener("submit", function () {
          var btn = form.querySelector("button[type='submit']");
          if (!btn || btn.disabled) {
            return;
          }
          btn.disabled = true;
          btn.textContent = btn.getAttribute("data-loading-label") || "Loading...";
        });
      });

      var sessionDetail = document.getElementById("workbench-session-detail");
      if (!sessionDetail) {
        return;
      }
      var sessionId = String(sessionDetail.getAttribute("data-session-id") || "").trim();
      if (!sessionId) {
        return;
      }
      var lastEventIndex = Number(sessionDetail.getAttribute("data-event-count") || "0");
      if (!Number.isFinite(lastEventIndex) || lastEventIndex < 0) {
        lastEventIndex = 0;
      }

      function scheduleReload() {
        if (refreshPending) {
          return;
        }
        refreshPending = true;
        window.location.reload();
      }

      function pollEvents() {
        var url = "/workbench/sessions/" + encodeURIComponent(sessionId) + "/events?after=" + String(Math.floor(lastEventIndex)) + "&limit=200";
        window.fetch(url, { headers: { Accept: "application/json" } })
          .then(function (resp) {
            if (!resp.ok) {
              return null;
            }
            return resp.json();
          })
          .then(function (doc) {
            if (!doc || doc.mode !== "polling") {
              return;
            }
            var eventCount = Number(doc.event_count || 0);
            var totalCount = Number(doc.total_event_count || 0);
            if (eventCount > 0) {
              scheduleReload();
              return;
            }
            if (Number.isFinite(totalCount) && totalCount > lastEventIndex) {
              lastEventIndex = totalCount;
            }
          })
          .catch(function () {
            return null;
          });
      }

      window.setInterval(pollEvents, 2500);
    });
  </script>
{% endblock %}
