{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Workbench</h1>
    <p class="page-subtitle">Phase-0 to Phase-4 session orchestration entry. Session state, cards, and events are persisted under artifacts/workbench.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Active Sessions</h2>
      {% if sessions and sessions|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>session_id</th>
              <th>status</th>
              <th>current step</th>
              <th>title</th>
              <th>updated_at</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sessions %}
            <tr>
              <td><a href="/ui/workbench/{{ s.session_id }}">{{ s.session_id }}</a></td>
              <td><span class="pill">{{ s.status }}</span></td>
              <td>{{ s.current_step }}</td>
              <td>{{ s.title }}</td>
              <td>{{ s.updated_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No workbench sessions yet. Create one via POST /workbench/sessions.</div>
      {% endif %}
      <p class="muted">Requirement entry alias: <a href="/ui/workbench/req/wb-002">/ui/workbench/req/wb-002</a></p>
    </div>

    <div class="card">
      <h2>Create Session (UI)</h2>
      <form method="post" action="/workbench/sessions" class="form-grid" data-loading-form="1">
        <input type="hidden" name="_ui" value="1"/>
        <label>
          <span>title</span>
          <input name="title" value="Workbench idea" required/>
        </label>
        <label>
          <span>symbols</span>
          <input name="symbols" value="AAPL,MSFT" required/>
        </label>
        <label class="full">
          <span>hypothesis_text</span>
          <textarea name="hypothesis_text" rows="3" required>Mean revert entry</textarea>
        </label>
        <label class="full">
          <span>message (real-jobs mode)</span>
          <textarea name="message" rows="2" placeholder="帮我检查A股 MA250 的有效性"></textarea>
        </label>
        <label>
          <span>frequency</span>
          <input name="frequency" value="1d"/>
        </label>
        <label>
          <span>evaluation_intent</span>
          <input name="evaluation_intent" value="demo_e2e"/>
        </label>
        <div class="full">
          <button type="submit" class="btn" data-loading-label="Creating...">Create Workbench Session</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <h2>Workbench API Quick Start</h2>
    <pre class="code">
POST /workbench/sessions
GET  /workbench/sessions/{session_id}
POST /workbench/sessions/{session_id}/message
POST /workbench/sessions/{session_id}/continue
GET  /workbench/sessions/{session_id}/events
POST /workbench/sessions/{session_id}/fetch-probe
POST /workbench/sessions/{session_id}/steps/{step}/drafts
POST /workbench/sessions/{session_id}/steps/{step}/drafts/{version}/apply
    </pre>
      <p class="muted">Artifacts:
        <code>artifacts/workbench/sessions/&lt;session_id&gt;/session.json</code>,
        <code>artifacts/workbench/sessions/&lt;session_id&gt;/events.jsonl</code>,
        <code>artifacts/jobs/&lt;job_id&gt;/outputs/workbench/cards/*.json</code>,
        <code>artifacts/jobs/&lt;job_id&gt;/outputs/workbench/step_drafts/&lt;step&gt;/selected.json</code>
      </p>
  </div>

  {% if selected_session %}
    <div class="card">
      <h2>Session Detail</h2>
      {% set s = selected_session.session %}
      <div class="code-wrap">
        <p><strong>Session:</strong> {{ s.session_id }} | <strong>status:</strong> {{ s.status }} | <strong>current step:</strong> {{ s.current_step }}</p>
        <p><strong>job_id:</strong> {{ s.job_id }} | <strong>created:</strong> {{ s.created_at }}</p>
        <p><strong>cards:</strong> {{ selected_session.cards_path }}</p>
      </div>

      <h3>Actions</h3>
      <div class="grid">
        <div>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/continue" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <label>
              <span>target_step (optional)</span>
              <select name="target_step">
                <option value="">auto next</option>
                {% for step in selected_session.steps %}
                <option value="{{ step }}">{{ step }}</option>
                {% endfor %}
              </select>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Continuing...">Continue / Refresh</button>
            </div>
          </form>
        </div>
        <div>
          <form method="post" action="/workbench/sessions/{{ s.session_id }}/fetch-probe" class="form-grid" data-loading-form="1">
            <input type="hidden" name="_ui" value="1"/>
            <label>
              <span>symbols</span>
              <input name="symbols" value="{{ (s.idea.symbols | join(',')) if s.idea and s.idea.symbols else '' }}" placeholder="AAPL,MSFT"/>
            </label>
            <div class="full">
              <button type="submit" class="btn" data-loading-label="Fetching...">Run Fetch Probe</button>
            </div>
          </form>
        </div>
      </div>

      <h3>Phase-0 Fetch Preview</h3>
      {% set fetch_status = s.fetch_probe_status if s.fetch_probe_status else 'idle' %}
      <p><strong>Status:</strong> <span class="pill">{{ fetch_status }}</span></p>
      {% if s.fetch_probe_error %}
        <div class="plot-fallback">Last fetch error: {{ s.fetch_probe_error }}</div>
      {% elif fetch_status == "running" %}
        <div class="plot-fallback">Fetch probe is running. Refresh this page to see the latest preview state.</div>
      {% endif %}
      {% if s.fetch_probe_preview_rows and s.fetch_probe_preview_rows|length > 0 %}
      {% set preview_rows = s.fetch_probe_preview_rows %}
      {% set preview_cols = preview_rows[0].keys() %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              {% for c in preview_cols %}
              <th>{{ c }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in preview_rows %}
            <tr>
              {% for c in preview_cols %}
              <td>{{ row.get(c, '') }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No fetch preview rows yet.</div>
      {% endif %}

      <h3>Trace</h3>
      {% if s.trace and s.trace|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>step</th><th>status</th><th>status_text</th><th>action</th></tr>
          </thead>
          <tbody>
            {% for row in s.trace %}
            <tr>
              <td>{{ row.step }}</td>
              <td>{{ row.status }}</td>
              <td>{{ row.status_text }}</td>
              <td>
                {% if row.step == s.current_step %}
                  <form method="post" action="/workbench/sessions/{{ s.session_id }}/continue" data-loading-form="1">
                    <input type="hidden" name="_ui" value="1"/>
                    <input type="hidden" name="target_step" value="{{ row.step }}"/>
                    <button type="submit" class="btn btn-small" data-loading-label="继续中...">继续</button>
                  </form>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No trace rows yet.</div>
      {% endif %}

      <h3>Recent Events ({{ selected_session.event_count }})</h3>
      {% if selected_session.events and selected_session.events|length > 0 %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>time</th><th>step</th><th>event</th></tr>
          </thead>
          <tbody>
            {% for item in selected_session.events %}
            <tr>
              <td>{{ item.created_at }}</td>
              <td>{{ item.step }}</td>
              <td>{{ item.event_type }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="plot-fallback">No events yet.</div>
      {% endif %}

      <h3>Result Cards ({{ selected_session.cards_count }})</h3>
      {% if selected_session.cards and selected_session.cards|length > 0 %}
      <div class="card-stack">
        {% for card in selected_session.cards %}
        <div class="card">
          <p><strong>{{ card.phase_label }}</strong> | {{ card.title }} | <code>{{ card.card_id }}</code></p>
          {% if card.summary_lines and card.summary_lines|length > 0 %}
          <ul>
            {% for line in card.summary_lines %}
            <li>{{ line }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="plot-fallback">No summary lines.</div>
          {% endif %}
          {% if card.phase == "strategy_spec" and card.details %}
            {% set readable = card.details.get("strategy_readable", {}) %}
            {% if readable and readable.get("available") %}
              <p><strong>Pseudocode</strong></p>
              <pre class="code">{{ readable.get("pseudocode_text", "") }}</pre>
              {% set var_summary = readable.get("variable_dictionary_summary", {}) %}
              {% set trace_summary = readable.get("trace_plan_summary", {}) %}
              <div class="table-wrap">
                <table class="table">
                  <tbody>
                    <tr><th>variable_count</th><td>{{ var_summary.get("variable_count", 0) }}</td></tr>
                    <tr><th>lagged_variable_count</th><td>{{ var_summary.get("lagged_variable_count", 0) }}</td></tr>
                    <tr><th>trace_steps</th><td>{{ trace_summary.get("step_count", 0) }}</td></tr>
                    <tr><th>trace_assertions</th><td>{{ trace_summary.get("assertion_count", 0) }}</td></tr>
                    <tr><th>sample_windows</th><td>{{ trace_summary.get("sample_windows", []) | join(" ; ") }}</td></tr>
                  </tbody>
                </table>
              </div>
            {% endif %}
          {% endif %}
          {% if card.phase == "trace_preview" and card.details and card.details.get("sample_rows") %}
            {% set card_rows = card.details.get("sample_rows", []) %}
            {% set card_cols = card_rows[0].keys() %}
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    {% for c in card_cols %}
                    <th>{{ c }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in card_rows %}
                  <tr>
                    {% for c in card_cols %}
                    <td>{{ row.get(c, "") }}</td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
          <details>
            <summary>Evidence details (collapsed by default)</summary>
            <pre class="code">{{ card.evidence_json }}</pre>
          </details>
          <details>
            <summary>Card payload</summary>
            <pre class="code">{{ card.details_json }}</pre>
          </details>
          <p class="muted"><code>{{ card.artifact_path }}</code></p>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="plot-fallback">No result cards yet. Continue the session to generate phase cards.</div>
      {% endif %}
    </div>
  {% endif %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll("form[data-loading-form='1']").forEach(function (form) {
        form.addEventListener("submit", function () {
          var btn = form.querySelector("button[type='submit']");
          if (!btn || btn.disabled) {
            return;
          }
          btn.disabled = true;
          btn.textContent = btn.getAttribute("data-loading-label") || "Loading...";
        });
      });
    });
  </script>
{% endblock %}
