{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Playbook Phase Matrix Read-Only Evidence</h1>
    <p class="page-subtitle">
      Read-only matrix sourced from Playbook section <code>3</code> and SSOT
      <code>phase_dispatch_plan_v2</code> + <code>goal_checklist</code> status mapping.
    </p>
  </div>

  <div class="card">
    <h2>Governance Boundary</h2>
    <div class="muted">This page is evidence-only and exposes no write actions.</div>
    <div class="section">
      <span class="pill">GET/HEAD only</span>
      <span class="pill">no write actions</span>
      <span class="pill">no holdout expansion</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Source Sections</h2>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>path</th><th>section</th><th>status</th></tr></thead>
          <tbody>
          {% for row in source_files %}
            <tr>
              <td><code>{{ row.path }}</code></td>
              <td>{{ row.section }}</td>
              <td>{% if row.exists %}<span class="pill good">present</span>{% else %}<span class="pill bad">missing</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>G36 Goal Snapshot</h2>
      <div class="kv">
        <div class="k">goal_id</div>
        <div class="v"><span class="pill">{{ g36.id if g36.id else "G36" }}</span></div>
        <div class="k">title</div>
        <div class="v">{{ g36.title if g36.title else "n/a" }}</div>
        <div class="k">status_now</div>
        <div class="v"><span class="pill">{{ g36.status_now if g36.status_now else "unknown" }}</span></div>
        <div class="k">ui_path</div>
        <div class="v"><code>{{ g36.ui_path if g36.ui_path else "n/a" }}</code></div>
        <div class="k">depends_on</div>
        <div class="v">{{ g36.depends_on|join(", ") if g36.depends_on else "n/a" }}</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Matrix Summary</h2>
      <div class="kv">
        <div class="k">playbook_phase_total</div>
        <div class="v"><span data-testid="playbook-phase-total">{{ summary.playbook_phase_total }}</span></div>
        <div class="k">dispatch_phase_total</div>
        <div class="v"><span data-testid="dispatch-phase-total">{{ summary.dispatch_phase_total }}</span></div>
        <div class="k">mapped_dispatch_total</div>
        <div class="v"><span data-testid="mapped-dispatch-total">{{ summary.mapped_dispatch_total }}</span></div>
        <div class="k">unmapped_dispatch_total</div>
        <div class="v"><span data-testid="unmapped-dispatch-total">{{ summary.unmapped_dispatch_total }}</span></div>
        <div class="k">goal_checklist_total</div>
        <div class="v"><span data-testid="goal-checklist-total">{{ summary.goal_checklist_total }}</span></div>
      </div>
    </div>

    <div class="card">
      <h2>Dispatch Meta</h2>
      <div class="kv">
        <div class="k">table</div>
        <div class="v"><code>phase_dispatch_plan_v2</code></div>
        <div class="k">status_now</div>
        <div class="v"><span class="pill">{{ dispatch_meta.status_now if dispatch_meta.status_now else "n/a" }}</span></div>
        <div class="k">mode</div>
        <div class="v"><span class="pill">{{ dispatch_meta.mode if dispatch_meta.mode else "n/a" }}</span></div>
        <div class="k">goal_source</div>
        <div class="v"><code>goal_checklist</code></div>
      </div>
      <div class="section">
        <h2>Goal Status Distribution</h2>
        {% if goal_status_rows %}
          {% for row in goal_status_rows %}
            <div><span class="pill">{{ row.status }}</span> {{ row.count }}</div>
          {% endfor %}
        {% else %}
          <div class="plot-fallback">No dispatch goal statuses loaded.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Playbook Section 3 Phase Matrix</h2>
    {% if playbook_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase</th><th>playbook_title</th><th>mapped_dispatch_goals</th><th>status_summary</th></tr></thead>
          <tbody>
          {% for row in playbook_rows %}
            <tr data-testid="playbook-phase-row-{{ loop.index }}">
              <td>
                <div><span class="pill">{{ row.phase_label }}</span></div>
                <div class="muted">line {{ row.source_line }}</div>
              </td>
              <td>{{ row.title }}</td>
              <td>
                <div><span class="pill">{{ row.mapped_total }}</span></div>
                {% if row.dispatch_rows %}
                  {% for item in row.dispatch_rows %}
                    <div>
                      <code>{{ item.phase_id }}</code> -> <code>{{ item.goal_id }}</code>
                      <span class="pill">{{ item.goal_status }}</span>
                    </div>
                  {% endfor %}
                {% endif %}
              </td>
              <td>
                {% if row.status_rows %}
                  {% for item in row.status_rows %}
                    <div><span class="pill">{{ item.status }}</span> {{ item.count }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No phase rows extracted from Playbook section 3.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>SSOT Dispatch-to-Playbook Mapping</h2>
    {% if dispatch_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase_id</th><th>goal_id</th><th>dispatch_title</th><th>mapped_playbook_phase</th><th>goal_status</th><th>ui_path</th><th>depends_on</th><th>mapping_reason</th></tr></thead>
          <tbody>
          {% for row in dispatch_rows %}
            <tr data-testid="dispatch-row-{{ loop.index }}">
              <td><code>{{ row.phase_id }}</code></td>
              <td><code>{{ row.goal_id }}</code></td>
              <td>{{ row.dispatch_title }}</td>
              <td><span class="pill">{{ row.mapped_phase_label }}</span></td>
              <td><span class="pill">{{ row.goal_status }}</span></td>
              <td>{% if row.goal_ui_path %}<code>{{ row.goal_ui_path }}</code>{% else %}<span class="muted">n/a</span>{% endif %}</td>
              <td>{{ row.depends_on|join(", ") if row.depends_on else "n/a" }}</td>
              <td>{{ row.mapping_reason }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No dispatch rows found under phase_dispatch_plan_v2.</div>
    {% endif %}
  </div>

  {% if unmapped_dispatch_rows %}
  <div class="card">
    <h2>Unmapped Dispatch Rows</h2>
    {% for row in unmapped_dispatch_rows %}
      <div><code>{{ row.phase_id }}</code> / <code>{{ row.goal_id }}</code> - {{ row.dispatch_title }}</div>
    {% endfor %}
  </div>
  {% endif %}
{% endblock %}
