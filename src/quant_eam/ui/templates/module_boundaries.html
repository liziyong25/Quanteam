{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">Whole View Modules Deterministic-Agent Boundary Evidence</h1>
    <p class="page-subtitle">
      Read-only evidence sourced from Whole View section <code>6</code> module boundaries,
      Playbook phase flow/context text, and SSOT governance references.
    </p>
  </div>

  <div class="card">
    <h2>Governance Boundary</h2>
    <div class="muted">This page is evidence-only and exposes no write actions.</div>
    <div class="section">
      <span class="pill">GET/HEAD only</span>
      <span class="pill">no write actions</span>
      <span class="pill">no holdout expansion</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Source Sections</h2>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>path</th><th>section</th><th>status</th></tr></thead>
          <tbody>
          {% for row in source_files %}
            <tr>
              <td><code>{{ row.path }}</code></td>
              <td>{{ row.section }}</td>
              <td>{% if row.exists %}<span class="pill good">present</span>{% else %}<span class="pill bad">missing</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>G41 Goal Snapshot</h2>
      <div class="kv">
        <div class="k">goal_id</div>
        <div class="v"><span class="pill">{{ g41.id if g41.id else "G41" }}</span></div>
        <div class="k">title</div>
        <div class="v">{{ g41.title if g41.title else "n/a" }}</div>
        <div class="k">status_now</div>
        <div class="v"><span class="pill">{{ g41.status_now if g41.status_now else "unknown" }}</span></div>
        <div class="k">ui_path</div>
        <div class="v"><code>{{ g41.ui_path if g41.ui_path else "/ui/module-boundaries" }}</code></div>
        <div class="k">depends_on</div>
        <div class="v">{{ g41.depends_on|join(", ") if g41.depends_on else "n/a" }}</div>
        <div class="k">expected_state_change</div>
        <div class="v">{{ g41.expected_state_change if g41.expected_state_change else "n/a" }}</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Boundary Summary</h2>
      <div class="kv">
        <div class="k">whole_view_modules</div>
        <div class="v"><span data-testid="module-boundary-module-total">{{ summary.module_total }}</span></div>
        <div class="k">deterministic_modules</div>
        <div class="v"><span data-testid="module-boundary-deterministic-total">{{ summary.deterministic_module_total }}</span></div>
        <div class="k">agent_modules</div>
        <div class="v"><span data-testid="module-boundary-agent-total">{{ summary.agent_module_total }}</span></div>
        <div class="k">boundary_entries</div>
        <div class="v"><span data-testid="module-boundary-entry-total">{{ summary.boundary_entry_total }}</span></div>
        <div class="k">playbook_phases</div>
        <div class="v"><span data-testid="module-boundary-playbook-phase-total">{{ summary.playbook_phase_total }}</span></div>
        <div class="k">mapped_modules</div>
        <div class="v"><span data-testid="module-boundary-mapped-total">{{ summary.mapped_module_total }}</span></div>
        <div class="k">required_guards</div>
        <div class="v"><span data-testid="module-boundary-required-guard-total">{{ summary.required_guard_total }}</span></div>
        <div class="k">global_read_rules</div>
        <div class="v"><span data-testid="module-boundary-global-rule-total">{{ summary.global_read_rule_total }}</span></div>
      </div>
    </div>

    <div class="card">
      <h2>SSOT Dispatch + Pipeline Meta</h2>
      <div class="kv">
        <div class="k">dispatch_table</div>
        <div class="v"><code>phase_dispatch_plan_v2</code></div>
        <div class="k">dispatch.status_now</div>
        <div class="v"><span class="pill">{{ dispatch.status_now if dispatch.status_now else "n/a" }}</span></div>
        <div class="k">dispatch.mode</div>
        <div class="v"><span class="pill">{{ dispatch.mode if dispatch.mode else "n/a" }}</span></div>
        <div class="k">phase_id</div>
        <div class="v"><code>{{ dispatch.phase_id }}</code></div>
        <div class="k">goal_id</div>
        <div class="v"><code>{{ dispatch.goal_id }}</code></div>
        <div class="k">dispatch_title</div>
        <div class="v">{{ dispatch.title if dispatch.title else "n/a" }}</div>
        <div class="k">exception_id</div>
        <div class="v"><code>{{ g41_exception.exception_id if g41_exception.exception_id else "g41_module_boundaries_ui_scope" }}</code></div>
        <div class="k">pipeline</div>
        <div class="v"><code>agents_pipeline_v1</code></div>
        <div class="k">execution_model</div>
        <div class="v"><span class="pill">{{ pipeline.execution_model if pipeline.execution_model else "n/a" }}</span></div>
        <div class="k">orchestration_owner</div>
        <div class="v"><span class="pill">{{ pipeline.orchestration_owner if pipeline.orchestration_owner else "n/a" }}</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Whole View Section 6 Module Responsibilities</h2>
    {% if module_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>module</th><th>responsibility_boundary</th><th>playbook_phase_context_mapping</th></tr></thead>
          <tbody>
          {% for row in module_rows %}
            <tr data-testid="module-boundary-row-{{ loop.index }}">
              <td>
                <div><span class="pill">{{ row.section_id }}</span> <strong>{{ row.plane_name }}</strong></div>
                <div>{{ row.module_title }}</div>
                <div class="muted">line {{ row.source_line }}</div>
                <div><span class="pill">{{ row.module_type }}</span></div>
              </td>
              <td>
                {% if row.note_rows %}
                  {% for note in row.note_rows %}
                    <div class="muted">{{ note }}</div>
                  {% endfor %}
                {% endif %}
                {% if row.boundary_rows %}
                  {% for entry in row.boundary_rows %}
                    <div>
                      <span class="pill">{{ entry.component if entry.component else "item" }}</span>
                      {% if entry.boundary %}{{ entry.boundary }}{% else %}<span class="muted">n/a</span>{% endif %}
                    </div>
                  {% endfor %}
                {% elif row.responsibility_rows %}
                  {% for item in row.responsibility_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
              <td>
                <div><span class="pill">{{ row.playbook_phase_total }}</span></div>
                {% if row.playbook_phase_rows %}
                  {% for phase in row.playbook_phase_rows %}
                    <div>
                      <span class="pill">{{ phase.phase_label }}</span>
                      {{ phase.title }}
                    </div>
                    {% if phase.goal_excerpt %}
                      <div class="muted">goal: {{ phase.goal_excerpt }}</div>
                    {% endif %}
                    {% if phase.background_excerpt %}
                      <div class="muted">background: {{ phase.background_excerpt }}</div>
                    {% endif %}
                    {% if phase.flow_excerpt %}
                      <div class="muted">flow: {{ phase.flow_excerpt }}</div>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="muted">no phase context match</span>
                {% endif %}
                {% if row.matched_keywords %}
                  <div class="muted">keywords: {{ row.matched_keywords|join(", ") }}</div>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No module rows extracted from Whole View section 6.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>Playbook Phase Flow/Context (Section 3)</h2>
    {% if playbook_rows %}
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>phase</th><th>title</th><th>goal_context</th><th>background_context</th></tr></thead>
          <tbody>
          {% for row in playbook_rows %}
            <tr data-testid="module-boundary-playbook-row-{{ loop.index }}">
              <td><span class="pill">{{ row.phase_label }}</span></td>
              <td>
                <div>{{ row.title }}</div>
                <div class="muted">line {{ row.source_line }}</div>
              </td>
              <td>
                {% if row.goal_rows %}
                  {% for item in row.goal_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
              <td>
                {% if row.background_rows %}
                  {% for item in row.background_rows %}
                    <div>{{ item }}</div>
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="plot-fallback">No phase rows extracted from Playbook section 3.</div>
    {% endif %}
  </div>

  <div class="card">
    <h2>SSOT Module Boundary Governance Evidence</h2>
    <div class="section">
      <h2>g41_module_boundaries_ui_scope.required_guards</h2>
      {% if g41_exception.required_guards %}
        {% for row in g41_exception.required_guards %}
          <div data-testid="module-boundary-guard-{{ loop.index }}">{{ row }}</div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No required guards under g41_module_boundaries_ui_scope.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>agents_pipeline_v1.global_read_rules</h2>
      {% if pipeline.global_read_rules %}
        {% for row in pipeline.global_read_rules %}
          <div data-testid="module-boundary-global-rule-{{ loop.index }}">{{ row }}</div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No global_read_rules found in agents_pipeline_v1.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>g41_module_boundaries_ui_scope.still_forbidden</h2>
      {% if g41_exception.still_forbidden %}
        {% for row in g41_exception.still_forbidden %}
          <div><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No still_forbidden rows found.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2>g41_module_boundaries_ui_scope.allowed_route_prefixes</h2>
      {% if g41_exception.allowed_route_prefixes %}
        {% for row in g41_exception.allowed_route_prefixes %}
          <div><code>{{ row }}</code></div>
        {% endfor %}
      {% else %}
        <div class="plot-fallback">No allowed_route_prefixes rows found.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
