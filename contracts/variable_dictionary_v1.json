{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://quant-eam.local/contracts/variable_dictionary_v1.json",
  "title": "variable_dictionary_v1",
  "type": "object",
  "additionalProperties": true,
  "$comment": "Contracts define I/O only. Variables are declarative; no executable scripts. Alignment lag is used to prevent lookahead.",
  "required": ["schema_version", "variables"],
  "properties": {
    "schema_version": {
      "const": "variable_dictionary_v1",
      "description": "Schema version discriminator. Must be exactly 'variable_dictionary_v1'."
    },
    "extensions": {
      "type": "object",
      "additionalProperties": true,
      "description": "Forward-compatible extension area. Must not be used to override governance/policies."
    },
    "variables": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/variable" }
    }
  },
  "$defs": {
    "variable": {
      "type": "object",
      "additionalProperties": true,
      "required": ["var_id", "kind", "dtype", "alignment", "missing_policy"],
      "properties": {
        "var_id": {
          "type": "string",
          "pattern": "^[A-Za-z][A-Za-z0-9_]*$",
          "description": "Stable variable id."
        },
        "kind": {
          "type": "string",
          "enum": ["field", "feature", "signal"],
          "description": "field=raw data field, feature=derived numeric series, signal=boolean signal."
        },
        "dtype": {
          "type": "string",
          "enum": ["float", "int", "bool", "str", "datetime", "object"],
          "description": "Logical dtype."
        },
        "source": { "$ref": "#/$defs/source" },
        "compute": { "$ref": "#/$defs/compute" },
        "alignment": { "$ref": "#/$defs/alignment" },
        "missing_policy": { "$ref": "#/$defs/missing_policy" },
        "notes": { "type": "string" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "kind": { "const": "field" } },
            "required": ["kind"]
          },
          "then": { "required": ["source"] },
          "else": { "required": ["compute"] }
        },
        {
          "if": {
            "properties": { "kind": { "const": "signal" } },
            "required": ["kind"]
          },
          "then": {
            "properties": {
              "alignment": {
                "properties": { "lag_bars": { "minimum": 1 } },
                "required": ["lag_bars"]
              }
            }
          }
        }
      ]
    },
    "source": {
      "type": "object",
      "additionalProperties": true,
      "required": ["dataset_id", "field"],
      "properties": {
        "dataset_id": { "type": "string" },
        "field": { "type": "string" },
        "adjustment": { "type": "string" },
        "frequency": { "type": "string" },
        "asof_rule": {
          "type": ["object", "string"],
          "description": "Optional as-of rule for the dataset/field."
        }
      }
    },
    "compute": {
      "type": "object",
      "additionalProperties": true,
      "required": ["ast"],
      "properties": {
        "ast": {
          "$ref": "https://quant-eam.local/contracts/defs/expression_ast_v1.json",
          "description": "Declarative compute AST (shared with signal_dsl_v1)."
        }
      }
    },
    "alignment": {
      "type": "object",
      "additionalProperties": true,
      "required": ["lag_bars"],
      "properties": {
        "lag_bars": {
          "type": "integer",
          "minimum": 0,
          "description": "Lag in bars. For signals, must be >= 1 to avoid same-bar lookahead."
        },
        "timezone": { "type": "string" },
        "calendar": { "type": "string" }
      }
    },
    "missing_policy": {
      "type": "object",
      "additionalProperties": true,
      "required": ["mode"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["drop", "ffill", "bfill", "zero", "false", "nan", "keep"]
        },
        "value": { "type": ["number", "string", "boolean", "null"] },
        "limit": { "type": "integer", "minimum": 0 }
      }
    }
  }
}
