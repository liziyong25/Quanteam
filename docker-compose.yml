services:
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    ports:
      # Host ports (8002/3002) are published ports; containers listen on 8000/80.
      - "${EAM_PUBLISH_IP:-0.0.0.0}:${EAM_API_PORT_HOST:-8002}:8000"
    environment:
      - TZ=${TZ:-Asia/Taipei}
      - EAM_ENV=${EAM_ENV:-dev}
      - EAM_REPO=/app
      - EAM_ARTIFACT_ROOT=/artifacts
      - EAM_DATA_ROOT=/data
      - PYTHONPATH=/app/src
    volumes:
      - ${EAM_REPO_HOST:-.}:/app
      - ${EAM_ARTIFACTS_HOST:-./artifacts}:/artifacts
      - ${EAM_DATA_HOST:-./data}:/data
    user: "${EAM_UID:-1000}:${EAM_GID:-1000}"
    working_dir: /app
    command: ["uvicorn","quant_eam.api.app:app","--host","0.0.0.0","--port","8000","--reload"]

  ui:
    image: nginx:alpine
    depends_on:
      - api
    ports:
      - "${EAM_PUBLISH_IP:-0.0.0.0}:${EAM_UI_PORT_HOST:-3002}:80"
    volumes:
      - ./docker/nginx/ui_proxy.conf:/etc/nginx/conf.d/default.conf:ro

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    environment:
      - TZ=${TZ:-Asia/Taipei}
      - EAM_ENV=${EAM_ENV:-dev}
      - EAM_REPO=/app
      - EAM_ARTIFACT_ROOT=/artifacts
      - EAM_DATA_ROOT=/data
      - PYTHONPATH=/app/src
    volumes:
      - ${EAM_REPO_HOST:-.}:/app
      - ${EAM_ARTIFACTS_HOST:-./artifacts}:/artifacts
      - ${EAM_DATA_HOST:-./data}:/data
    user: "${EAM_UID:-1000}:${EAM_GID:-1000}"
    working_dir: /app
    command: ["python","-m","quant_eam.worker.main"]
